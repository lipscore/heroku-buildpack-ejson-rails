#!/usr/bin/env bash
set -euo pipefail

step() { echo "-----> $*"; }
fail() { echo " !!    ERROR: $*" >&2; exit 1; }

# Get absolute path of the script
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# Assume app root is 2 levels above (adjust if your buildpack is nested differently)
APP_ROOT="$SCRIPT_DIR/../.."

step "Detecting EJSON buildpack"
step "Script directory: $SCRIPT_DIR"
step "App root directory (expected): $APP_ROOT"

CONFIG_SECRETS="$APP_ROOT/config/secrets"
step "Checking for config/secrets at: $CONFIG_SECRETS"

if [ ! -d "$CONFIG_SECRETS" ]; then
  fail "config/secrets directory not found"
fi

EJSON_FILES=$(ls "$CONFIG_SECRETS"/*.ejson 2>/dev/null || true)
if [ -z "$EJSON_FILES" ]; then
  fail "No .ejson files found in config/secrets"
fi

step "EJSON buildpack detected"
step "Found the following .ejson files:"
echo "$EJSON_FILES"

exit 0
